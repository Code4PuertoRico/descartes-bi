{% load simplehelpers %}
{% load i18n %}
{% load static %}
{% if not chart_data %}
    {% with 'Attention' as title %}
    {% with 'There are no results for the selected parameters, choose other values.' as message %}
    {% include "messagebox-attention.html" %}
    {% endwith %}
    {% endwith %}
{% else %}
{% if 0 %}
QUERY: {{ query }}<br />
PARAMS: {{ params }}<br />
chart_series: {{ chart_series.0.tick_format }}<br />
SERIES_RESULTS: {{series_results }}<br />
CHART_DATA: {{ chart_data }}<br />
chart.trendline : {{ chart.trendline }}<br />
chart.pointlabels: {{ chart.pointlabels}}<br />
chart.highliter: {{ chart.highlighter}}<br />
chart.type : {{chart.type}}<br />
chart.title: {{ chart.title }}<br />
chart_data|safe: {{ chart_data|safe }} <br />
chart.legend: {{chart.legend}}<br />
chart.series_label : {{ chart.series_label }}<br />
legendLocation: {{ chart.legend_location|default:"ne" }}<br />

{% endif %}
    <link href="{% static 'packages/novus-nvd3/src/nv.d3.css' %}" rel="stylesheet" type="text/css">
    <style>

        body {
          overflow-y:scroll;
        }

        text {
          font: 12px sans-serif;
        }

        #chart{{ chart.id }} svg {
          height: 400px;
          margin: 10px;
          min-width: 100px;
          min-height: 100px;
        }
    </style>
    <body>

      <div id="chart{{ chart.id }}" style="margin:2px; color: #666;">
        {% if chart.title %}
            <h1>{{ chart.title }}</h1>
        {% endif %}
        <svg> </svg>
      </div>
    <script src="{% static 'packages/novus-nvd3/lib/d3.v3.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/nv.d3.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/utils.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/tooltip.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/models/legend.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/models/axis.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/models/scatter.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/models/line.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/models/historicalBar.js' %}"></script>
    <script src="{% static 'packages/novus-nvd3/src/models/linePlusBarChart.js' %}"></script>

    <script>
    var data = [
        {% for series_result in series_results %}
            {
                "values" : JSON.parse('{{ series_result|safe }}'),
            },
        {% endfor %}
    ].map(function(series) {
      series.values = series.values.map(function(d) { 
        return {
            x: d[0], 
            y: d[1] 
        } 
    });
      return series;
    });

    // Insert chart legends and set graph type into each series
    {% for chart_serie in chart_series %}
        data[{{ forloop.counter0 }}]["key"] = "{{ chart_serie }}"

        {% if chart_serie.type == 'BA' %}
            // Is a bar type series
            data[{{ forloop.counter0 }}]["bar"] = true
        {% endif %}

    {% endfor %}
{% ifequal chart.type 'SI' %} 
var chart;
nv.addGraph(function() {
    chart = nv.models.multiBarChart()
      //.barColor(d3.scale.category20().range());// color by y data
      .color(d3.scale.category10().range());// color by diferent data
    chart.multibar
      .hideable(true);
    chart.reduceXTicks(true) // if date or number set: true else false
        .showControls(false) // six something here, change to false when data.len == 1
        .staggerLabels(false);

    chart.xAxis
        .showMaxMin(true);
      //  .tickFormat(d3.format(',f'));

    chart.yAxis
        .tickFormat(d3.format('d'));

    d3.select('#chart{{chart.id}} svg')
      .datum(data)
      .transition().duration(500).call(chart);

    nv.utils.windowResize(chart.update);

    chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });

    return chart;
});
{% endifequal%}
{% ifequal chart.type 'LI' %}
    var chart;
    nv.addGraph(function() {
      chart = nv.models.lineChart();
      chart
          .x(function(d,i) { return i })
    chart.xAxis.tickFormat(function(d) {
          console.log(data);
          return data[0].values[d].x;})

          .showMaxMin(false);
      chart.yAxis
          .axisLabel('Voltage (v)')
          .tickFormat(d3.format(',.2f'));

      chart.showXAxis(true);
      d3.select('#chart{{chart.id}} svg')
          //.datum([]) //for testing noData
          .datum(data)
          .transition().duration(500)
          .call(chart);
      //TODO: Figure out a good way to do this automatically
      nv.utils.windowResize(chart.update);
      //nv.utils.windowResize(function() { d3.select('#chart1 svg').call(chart) });
      chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
      return chart;
    });

{% endifequal %}
{% ifequal chart.type 'LB' %}
    var chart;

    nv.addGraph(function() {
        chart = nv.models.linePlusBarChart()
            .margin({top: 30, right: 60, bottom: 50, left: 70})
            .x(function(d,i) { return i })

            .color(d3.scale.category10().range());

        chart.xAxis.tickFormat(function(d) {
           var dx = data[0].values[d] && data[0].values[d].x || 0;
            if (dx) {
                // ro, make shure it prints all the x axis
                // Include dates format
                //dx = dx.split("-");// && dx.split("-");
                return dx;//d3.time.format('%B %Y')(new Date(dx[0], dx[1], 0, 0, 0, 0, 0)).toString();
            }
            else return '';
          })
          .showMaxMin(false);

        // TODO: get series format from model
        chart.y1Axis
            .tickFormat(d3.format(',f'));

        chart.y2Axis
            .tickFormat(function(d) { return '$' + d3.format(',.2f')(d) });
        //chart.reduceXTicks(true)
        chart.bars.forceY([0]).padData(false);
        //chart.lines.forceY([0]);

        d3.select('#chart{{ chart.id }} svg')
            .datum(data)
            .transition().duration(500).call(chart);

        nv.utils.windowResize(chart.update);
        chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
        return chart;
    });
{% endifequal %}
    </script>

    <div id='calculated' style="float: left;">
        <small>{% blocktrans with time_delta.seconds as seconds and time_delta.microseconds as microseconds %}Calculated in: {{ seconds }}.{{ microseconds }} seconds.{% endblocktrans %}</small>
    </div>
{% endif %}
