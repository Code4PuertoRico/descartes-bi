{% load simplehelpers %}
{% load i18n %}
{% if not chart_data %}
    {% with 'Attention' as title %}
    {% with 'There are no results for the selected parameters, choose other values.' as message %}
    {% include "messagebox-attention.html" %}
    {% endwith %}
    {% endwith %}
{% else %}

{% ifequal chart.type 'PI' %}
    <script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/pie.js"></script>
    <script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/pieChart.js"></script>
{% endifequal %}


{% if 0 %}
QUERY: {{ query }}<br />
PARAMS: {{ params }}<br />
CHART_DATA: {{ chart_data }}<br />
SERIES_LABELS: {{ series_labels }}<br />
LEYEND: {{ chart.legend_location }} <br />
CHART_SERIES: {{ chart_series }}<br />
SERIES_RESULTS 1: {{ series_results.0}}<br />
SERIES_RESULTS 2: {{ series_results.1}}<br />
CHART: {{ chart}} <br />
HAX : {{h_axis}}<br>
VAX : {{v_axis}}<br>

{% endif %}

{% if chart.title %}
    <h1>{{chart.title }}</h1>
{% endif %}

<link href="{{ MEDIA_URL }}packages/novus-nvd3/src/nv.d3.css" rel="stylesheet" type="text/css">
<style>

    body {
      overflow-y:scroll;
    }

    text {
      font: 12px sans-serif;
    }

    #chart1 svg {
      height: 500px;
      margin: 10px;
      min-width: 100px;
      min-height: 100px;}
</style> 
<body>

  <div id="chart1">
    <svg> </svg>
  </div>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/lib/d3.v3.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/nv.d3.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/utils.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/tooltip.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/legend.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/axis.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/scatter.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/line.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/historicalBar.js"></script>
<script src="{{ MEDIA_URL }}packages/novus-nvd3/src/models/linePlusBarChart.js"></script>

<script>
//For testing single data point
var data1 = '{{ series_results.0 }}';
var data2 = '{{ series_results.1 }}';
data1 = JSON.parse(data1.replace(/&quot;/g,'"'));
data2 = JSON.parse(data2.replace(/&quot;/g,'"'));

var testdata = [
  {
    // the key will give the legend names.
    "key" :'{{ chart_series.0 }}',
    "bar": true,
    "values" : data1
  } ,
  {
    "key" : '{{ chart_series.1 }}' ,
    "values" : data2
  }
].map(function(series) {
  series.values = series.values.map(function(d) { return {x: d[0], y: d[1] } });
  return series;
});


var chart;

nv.addGraph(function() {
    chart = nv.models.linePlusBarChart()
        .margin({top: 30, right: 60, bottom: 50, left: 70})
        .x(function(d,i) { return i })
        .color(d3.scale.category10().range());

    chart.xAxis.tickFormat(function(d) {
       var dx = testdata[0].values[d] && testdata[0].values[d].x || 0;
        if (dx) {
            // ro, make shure it prints all the x axis
            // Include dates format
            //dx = dx.split("-");// && dx.split("-");
            return dx;//d3.time.format('%B %Y')(new Date(dx[0], dx[1], 0, 0, 0, 0, 0)).toString();
        } 
        else return '';
      })
      .showMaxMin(false);

    chart.y1Axis
        .tickFormat(d3.format(',f'));

    chart.y2Axis
        .tickFormat(function(d) { return '$' + d3.format(',.2f')(d) });

    chart.bars.forceY([0]).padData(false);
    //chart.lines.forceY([0]);

    d3.select('#chart1 svg')
        .datum(testdata)
        .transition().duration(500).call(chart);

    nv.utils.windowResize(chart.update);
    chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
    return chart;
});

</script>


<!-- <div class="jqPlot" id="chart1" style="height: 97%; width: 100%; margin:auto; font-size: 110%; color: black; font-color: red; float: left;">
<script type="text/javascript">

    plot1 = $.jqplot('chart1', [{{ chart_data|safe }}], {
        title:'{{ chart.title }}',
        seriesColors: [ "#abc837", "#7A4012", "#507642", "#A37B45", "#CCCFBC", "#F3F4EC", "#FF0000", "#DFDAC7" ,"#FF6600", "#003366", "#666666"],

        {% if chart.legend %}
            legend:{ show: true, location: '{{ chart.legend_location|default:"ne" }}' },
        {% endif %}
        seriesDefaults: {
            //showMarker:false,
            pointLabels:{location:'{{ chart.pointlabels_location|default:"n" }}'}//, ypadding:33}
        },

        {% ifnotequal chart.type 'PI' %}
        axes:{
            {{ h_axis }}axis:{
                {% if chart.series_label %}label: '{{ chart.series_label }}',{% endif %}
                autoscale: true,
                renderer:$.jqplot.CategoryAxisRenderer

            },

            {% for s in chart_series %}
                {{ v_axis }}{% if not chart.use_one_scale %}{% ifnotequal chart_series.count 1 %}{{ forloop.counter|add:"1" }}{% endifnotequal %}{% endif %}axis:{
                autoscale: true,



                {% if s.serie.label %}
                    label: {% ifnotequal chart_series.count 1 %}{% if chart.use_one_scale %}'{{ chart.scale_label_override|default_if_none:"" }}'{% else %}'{{ s.serie.label }}'{% endif %}{% else %}'{{ s.serie.label }}'{% endifnotequal %},
                {% endif %}


                labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                tickOptions: {
                    angle: -90
                },



                    tickOptions: {
                        formatString: '{{ s.serie.tick_format|default:"%d" }}'
                    }
                    {% if s.zerobase %}
                        ,min: 0
                    {% endif %}
                 } {% if not forloop.last %},{% endif %}
            {% endfor %}
            },
        {% endifnotequal %}

        series: [
            {% for s in chart_series %}
                { label: '{{ s.serie.label }}'
                    {% if not chart.use_one_scale %}{% ifnotequal chart_series.count 1 %}
                        ,{{ v_axis }}axis:'{{ v_axis }}{{ forloop.counter|add:"1" }}axis'
                    {% endifnotequal %}{% endif %}
                    {% ifequal chart.type 'PI' %}
                        ,renderer:$.jqplot.PieRenderer,
                        rendererOptions:{
                            sliceMargin: 12
                        }
                    {% else %}
                        {% ifequal s.type 'BA' %}
                            ,renderer:$.jqplot.BarRenderer,
                            rendererOptions:{{% ifequal chart.orientation 'h' %}barDirection: 'horizontal'{% else %}barPadding: 8, barMargin: 20{% endifequal %} }
                        {% endifequal %}
                    {% endifequal %}
                } {% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
        {% if not chart.use_one_scale %}{% ifnotequal chart_series.count 1 %}
            ,axesDefaults:{ useSeriesColor: true }
        {% endifnotequal %}{% endif %}

        ,cursor: { {% if chart.zoom %} showTooltip:false, zoom:true, clickReset:true {% endif %}
            {% if chart.tracking %}
                {% if chart.zoom %},{% endif %}
                showVerticalLine: true,
                showHorizontalLine: true,
                showCursorLegend: false,
                intersectionThreshold: 66
            {% endif %}
            }

    });

</script>
</div>-->
<div id='calculated' style="float: left;">
    <small>{% blocktrans with time_delta.seconds as seconds and time_delta.microseconds as microseconds %}Calculated in: {{ seconds }}.{{ microseconds }} seconds.{% endblocktrans %}</small>
</div>
{% endif %}
